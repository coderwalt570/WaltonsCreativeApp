<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manager Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <header>
    <div class="header-left">
      <h1>Manager Dashboard</h1>
      <p id="welcome"></p>
    </div>
  <button class="logout-btn" onclick="logout()">Logout</button>
</header>

<main>
  <section class="tables">
    <h2>Projects</h2>
    <input type="text" id="projectSearch" placeholder="Search Projects..." oninput="filterTable('projectsTable', this.value)" />

    <table id="projectsTable">
      <thead>
        <tr>
          <th>Project ID</th>
          <th>Client</th>
          <th>Description</th>
          <th>Due Date</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Expenses</h2>
    <input type="text" id="expenseSearch" placeholder="Search Expenses..." oninput="filterTable('expensesTable', this.value)" />

    <table id="expensesTable">
      <thead>
        <tr>
          <th>Expense ID</th>
          <th>Category</th>
          <th>Amount</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="charts">
    <h2>Expenses Chart</h2>
    <canvas id="expenseChart" width="400" height="200"></canvas>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ✅ Logout user
  function logout() {
    fetch("/logout", { method: "POST" })
      .then(() => (window.location.href = "login.html"));
  }

  // ✅ Load User Name for Welcome Msg
  async function loadWelcome() {
    try {
      const res = await fetch("/session-user");
      if (!res.ok) return window.location.href = "login.html";
      const user = await res.json();
      document.getElementById("welcome").innerText = `Welcome, ${user.username}!`;
    } catch {
      window.location.href = "login.html";
    }
  }

  // ✅ Fetch and Display Dashboard Data
  async function fetchDashboardData() {
    try {
      const [projectsRes, expensesRes] = await Promise.all([
        fetch("/data/projects"),
        fetch("/data/expenses")
      ]);

      const projects = await projectsRes.json();
      const expenses = await expensesRes.json();
      
      populateTable("projectsTable", projects);
      populateTable("expensesTable", expenses);
      drawExpenseChart(expenses);

    } catch (err) {
      console.error(err);
      alert("Error loading dashboard");
      }
    }

    // ✅ Populate tables
    function populateTable(tableId, data) {
      const tbody = document.getElementById(tableId).querySelector("tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        Object.values(row).forEach(val => {
          const td = document.createElement("td");
          td.innerText = val;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    // ✅ Search / Filter Tables
    function filterTable(tableId, query) {
      const rows = document.getElementById(tableId).getElementsByTagName("tr");
      query = query.toLowerCase();
      for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        let match = false;
        for (let j = 0; j < cells.length; j++) {
          if (cells[j].innerText.toLowerCase().includes(query)) {
            match = true;
            break;
          }
        }
        rows[i].style.display = match ? "" : "none";
      }
    }

    // ✅ Draw Expense Chart
    function drawExpenseChart(expenses) {
      const ctx = document.getElementById("expenseChart").getContext("2d");
      const categoryTotals = {};
      
      expenses.forEach(e => {
        categoryTotals[e.Category] = (categoryTotals[e.Category] || 0) + parseFloat(e.Amount);
      });

      new Chart(ctx, {
        type: "pie",
        data: {
          labels: Object.keys(categoryTotals),
          datasets: [{
          label: "Expenses by Category",
          data: Object.values(categoryTotals),
          }]
        }
      });
    }

    loadWelcome();
    fetchDashboardData();
  </script>
</body>
</html>
